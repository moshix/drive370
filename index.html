<!DOCTYPE html>
<html>
  <head>
    <title>NightDriver</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" title="main" href="./css/drivey.css" />
  </head>
  <body>
    <script src="./lib/theme.js"></script>
    <script type="module">
      console.log("Starting music setup...");
      const audioPlayer = new Audio();
      let shuffledPlaylist = [];
      let currentTrackIndex = 0;

      // Set up the playlist first
      fetch('./')
        .then(response => response.text())
        .then(text => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');
          const files = [...doc.querySelectorAll('a')]
            .map(a => `./music/${a.textContent}`)
            .filter(href => href.endsWith('.flac'));
          
          console.log("Found FLAC files:", files);
          
          if (files.length > 0) {
            shuffledPlaylist = [...files].sort(() => Math.random() - 0.5);
            
            audioPlayer.addEventListener('ended', () => {
              console.log("Track ended, playing next...");
              currentTrackIndex++;
              if (currentTrackIndex >= shuffledPlaylist.length) {
                shuffledPlaylist.sort(() => Math.random() - 0.5);
                currentTrackIndex = 0;
              }
              audioPlayer.src = shuffledPlaylist[currentTrackIndex];
              audioPlayer.play();
            });
          }
        });

      // Start playing on first user interaction
      const startMusic = () => {
        console.log("Starting first track:", shuffledPlaylist[0]);
        audioPlayer.src = shuffledPlaylist[0];
        audioPlayer.play();
        // Remove the event listeners once music starts
        document.removeEventListener('click', startMusic);
        document.removeEventListener('keydown', startMusic);
      };

      document.addEventListener('click', startMusic);
      document.addEventListener('keydown', startMusic);

      // Original Drivey initialization
      import Drivey from "./js/Drivey.js";
      document.addEventListener("touchmove", (e) => e.preventDefault(), {
        passive: false,
      });
      window.drivey = new Drivey();
    </script>
  </body>
</html>
